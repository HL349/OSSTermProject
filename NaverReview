import csv
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from webdriver_manager.chrome import ChromeDriverManager
import time

# 크롬 드라이버 설정
chrome_options = Options()

# 웹 드라이버 서비스 설정
service = Service(ChromeDriverManager().install())

# 웹 드라이버 시작
driver = webdriver.Chrome(service=service, options=chrome_options)

# 네이버 지도 페이지로 이동
driver.get("https://map.naver.com/")
wait = WebDriverWait(driver, 10)

# 검색창에서 검색어 입력받기
search_term = input("검색할 장소를 입력하세요: ")
search_box = wait.until(EC.visibility_of_element_located((By.CSS_SELECTOR, "input.input_search")))
search_box.send_keys(search_term)
search_box.send_keys(Keys.ENTER)

# 첫 번째 검색 결과의 로딩이 완료될 때까지 대기
wait.until(EC.visibility_of_element_located((By.CSS_SELECTOR, "span.search_title_text")))

# 첫 번째 검색 결과 클릭 (동적 요소로 인해 클릭 가능하게 대기)
first_result = wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, ".search_list .lsnx_det")))
first_result.click()

# iframe으로 전환
driver.switch_to.frame("searchIframe")

# 리뷰 탭 클릭
review_tab = wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, "a.tab._reviewTab")))
review_tab.click()

# '더보기' 버튼을 반복적으로 클릭하여 모든 리뷰 로드
while True:
    try:
        more_button = wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, 'a._btn_more')))
        more_button.click()
        time.sleep(1)  # 페이지 로드 시간 대기
    except Exception:
        print("모든 리뷰가 로드되었습니다.")
        break

# 모든 리뷰 요소 추출
reviews = [element.text for element in driver.find_elements(By.CSS_SELECTOR, ".review_text")]

# 크롬 드라이버 종료
driver.quit()

# 리뷰 데이터를 CSV 파일로 저장
csv_file = 'naver_reviews.csv'
with open(csv_file, 'w', encoding='utf-8-sig', newline='') as file:
    writer = csv.writer(file)
    writer.writerow(['Review'])
    for review in reviews:
        writer.writerow([review])

print(f"Total {len(reviews)} reviews have been saved to {csv_file}")
